
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Transition path theory &#8212; deeptime 0.3.1+10.g65eecc5c.dirty documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/perfect-scrollbar/css/perfect-scrollbar.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/perfect-scrollbar/js/perfect-scrollbar.min.js"></script>
    <script src="../_static/perfect-scrollbar/js/perfect-scrollbar.min.js"></script>
    <script src="../_static/d3.v5.min.js"></script>
    <script src="../_static/d3-legend.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"></script>
    <script src="../_static/katex_autorenderer.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hidden Markov Models" href="hmm.html" />
    <link rel="prev" title="Coarse-graining with PCCA+" href="pcca.html" />
<link rel="apple-touch-icon" sizes="180x180" href="../_static/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../_static/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../_static/favicon-16x16.png">
<link rel="manifest" href="../_static/site.webmanifest">

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo/deeptime_romand_white.svg" alt="Logo"/>
    
  </a>
</p>










<!-- h3>Navigation</h3 -->
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index_dimreduction.html">Dimension reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index_deepdimreduction.html">Deep dim reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="sindy.html">SINDy</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index_msm.html">Markov state models</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="transition-counting.html">Transition counting</a></li>
<li class="toctree-l2"><a class="reference internal" href="mlmsm.html">Maximum-likelihood MSMs</a></li>
<li class="toctree-l2"><a class="reference internal" href="pcca.html">Coarse-graining with PCCA+</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Transition path theory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#The-committor">The committor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Reactive-probability-flux">Reactive probability flux</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Coarse-graining-of-fluxes">Coarse-graining of fluxes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Pathway-decomposition">Pathway decomposition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Example-from-trajectories">Example from trajectories</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="hmm.html">Hidden Markov Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="clustering.html">Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datasets/index.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index_dev.html">For developers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index_base.html">deeptime.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_clustering.html">deeptime.clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_sindy.html">deeptime.sindy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_covariance.html">deeptime.covariance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_decomposition.html">deeptime.decomposition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_markov.html">deeptime.markov</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_markov_hmm.html">deeptime.markov.hmm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_markov_tools.html">deeptime.markov.tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_basis.html">deeptime.basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_kernels.html">deeptime.kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_data.html">deeptime.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_numeric.html">deeptime.numeric</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_util.html">deeptime.util</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../imprint.html">Imprint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">Software License</a></li>
</ul>





<!--
<p>
    <iframe src="https://ghbtns.com/github-btn.html?user=deeptime-ml&repo=deeptime&type=star&count=true&size=large&v=2"
            allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>
--><p class="caption">
    <span class="caption-text">Version</span>
</p>
<ul>
    <li class="toctree-l1">
        <a class="reference internal" id="version-latest"
           href="../latest/../index.html">Latest release
            (0.3.1)</a>
    </li>
    <li class="toctree-l1">
        <a class="reference internal" id="version-trunk"
           href="../trunk/../index.html">Trunk version</a>
    </li>
</ul>
<script>
    if (window.location.href.indexOf("latest") > -1) {
        document.getElementById("version-latest").className = "reference internal current";
        document.getElementById("version-trunk").className = "reference internal";
    } else {
        document.getElementById("version-latest").className = "reference internal";
        document.getElementById("version-trunk").className = "reference internal current";
    }
</script><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../contents.html">Documentation overview</a><ul>
  <li><a href="../index_msm.html">Markov state models</a><ul>
      <li>Previous: <a href="pcca.html" title="previous chapter">Coarse-graining with PCCA+</a></li>
      <li>Next: <a href="hmm.html" title="next chapter">Hidden Markov Models</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" placeholder="Quick search" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><div class="github-wrapper">
    <a href="https://github.com/deeptime-ml/deeptime"
       style="width: 16rem; height:100%; position:absolute; top:0; left:0;">
        <img class="side-logo logo-github" src="../_static/GitHub-Mark-Light-32px.png" alt="gh"/>
        <div style="display: table; height: 100%; overflow: hidden;">
            <div style="display: table-cell; vertical-align: middle;">
                <div>deeptime &#64; GitHub
                </div>
            </div>
        </div>
    </a>
</div>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Transition-path-theory">
<h1>Transition path theory<a class="headerlink" href="#Transition-path-theory" title="Permalink to this headline">¶</a></h1>
<p>Transition path theory (TPT) <a class="footnote-reference brackets" href="#footcite-weinan2006towards" id="id1">1</a><a class="footnote-reference brackets" href="#footcite-metzner2009transition" id="id2">2</a> is a method to study the ensemble of reactive trajectories, i.e., trajectories which come from a defined set of states <span class="math">\(A\)</span> and go next to <span class="math">\(B\)</span>. It can answer at which rate they occur, as well as depict parallel pathways, traps, sequences of events, etc. Furthermore it introduces the notion of ‘committor functions’, which deals with probabilities of ending up in set <span class="math">\(A\)</span> or <span class="math">\(B\)</span> given
the trajectory starts at some state potentially outside <span class="math">\(A\cup B\)</span>.</p>
<p>The implementation is based on <a class="footnote-reference brackets" href="#footcite-noe2009constructing" id="id3">3</a>. Coarse-graining by path decomposition is presented in <a class="footnote-reference brackets" href="#footcite-noe2009constructing" id="id4">3</a> and <a class="footnote-reference brackets" href="#footcite-berezhkovskii2009reactive" id="id5">4</a>.</p>
<p>To demonstrate the TPT API (<a class="reference internal" href="../api/generated/deeptime.markov.ReactiveFlux.html#deeptime.markov.ReactiveFlux"><span class="std std-ref">API docs here</span></a>), in the following the example of a drunkard’s walk is presented. The example is motivated by <a class="footnote-reference brackets" href="#footcite-doyle1984random" id="id6">5</a> and <a class="footnote-reference brackets" href="#footcite-valleriani2015circular" id="id7">6</a>, where a drunkard is placed on a network of states and two special states, home and the bar. When the drunkard reaches either of these special states the trajectory stays there with high probability. One can then
ask which paths can be taken and also with which probability the drunkard is going to reach either of the states given a certain current position.</p>
<p>To this end, import numpy for general numerical operations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<p>We can create a <a class="reference internal" href="../api/generated/deeptime.data.drunkards_walk.html#deeptime.data.drunkards_walk"><span class="std std-ref">DrunkardsWalk</span></a> simulator by specifying bar and home locations. As the drunkard lives on a 2-dimensional grid, the locations are given in terms of integer coordinates. Internally, this is related back to <span class="math">\(\mathrm{width}\times\mathrm{height}\)</span> states.</p>
<p>There are four kinds of states: - home states: states which denote the location of the home - bar states: states which denote the location of the bar - barrier states: states which either cannot be crossed or can only be crossed by overcoming a potential (i.e., it is less likely to encounter these states in a trajectory) - normal states: the drunkard can move freely by taking a step onto one of the adjacent grid cells with uniform probability unless it is a barrier.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">deeptime.data</span> <span class="kn">import</span> <span class="n">drunkards_walk</span>

<span class="n">sim</span> <span class="o">=</span> <span class="n">drunkards_walk</span><span class="p">(</span><span class="n">grid_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                     <span class="n">bar_location</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span>
                     <span class="n">home_location</span><span class="o">=</span><span class="p">[(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<p>We can add hard and soft barriers by specifying start and end points of the barrier. If no weight is given, the barrier is <code class="docutils literal notranslate"><span class="pre">hard</span></code>, i.e., cannot be crossed by a trajectory. This enters the jump probabilities from adjacent cells <span class="math">\((i,j)\)</span> as</p>
<div class="math">
\[\mathbb{P}(x_{t+1}=\mathrm{barrier} \mid x_t = (i, j)) = \begin{cases} p \leq 1/\mathrm{weight} &\text{, if weight positive,}\\ 0 &\text{, otherwise.} \end{cases}\]</div>
<p>That means the larger the weight, the smaller the probability to cross the barrier.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">5.</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">5.</span><span class="p">)</span>

<span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">5.</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">add_barrier</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="mf">5.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we can simulate a trajectory on this grid by specifying a starting point and a number of simulation steps. The effective length of the trajectory might be lower than the number of simulation steps as the simulation stops if the state is <code class="docutils literal notranslate"><span class="pre">home</span></code> or <code class="docutils literal notranslate"><span class="pre">bar</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">walk</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of steps in the walk:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">walk</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of steps in the walk: 74
</pre></div></div>
</div>
<p>The trajectory can be visualized with a few helper functions attached to the simulator:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">sim</span><span class="o">.</span><span class="n">plot_path</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">walk</span><span class="p">)</span>
<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plot_2d_map</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_10_0.png" src="../_images/notebooks_tpt_10_0.png" />
</div>
</div>
<p>Here, the darker red squares denote hard barriers, the lighter red squares denote barriers which can be crossed. So one could imagine, that both home and bar are on a hill.</p>
<p>The simulator internally holds a <a class="reference internal" href="../api/generated/deeptime.markov.msm.MarkovStateModel.html#deeptime.markov.msm.MarkovStateModel"><span class="std std-ref">MarkovStateModel</span></a> on which one can call <a class="reference internal" href="../api/generated/deeptime.markov.msm.MarkovStateModel.html#deeptime.markov.msm.MarkovStateModel.reactive_flux"><span class="std std-ref">reactive_flux(A, B)</span></a>. This computes some quantities related to the ensemble of reactive trajectories between sets of states <span class="math">\(A\)</span> and <span class="math">\(B\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Internal Markov state model with </span><span class="si">{</span><span class="n">sim</span><span class="o">.</span><span class="n">msm</span><span class="o">.</span><span class="n">n_states</span><span class="si">}</span><span class="s2"> states to cover the </span><span class="si">{</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="si">}</span><span class="s2"> grid.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute reactive flux from A=</span><span class="si">{</span><span class="n">sim</span><span class="o">.</span><span class="n">home_state</span><span class="si">}</span><span class="s2"> to B=</span><span class="si">{</span><span class="n">sim</span><span class="o">.</span><span class="n">bar_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">msm</span><span class="o">.</span><span class="n">reactive_flux</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">home_state</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">bar_state</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Internal Markov state model with 100 states to cover the (10, 10) grid.
Compute reactive flux from A=[88, 98, 89, 99] to B=[0, 10, 1, 11]
</pre></div></div>
</div>
<section id="The-committor">
<h2>The committor<a class="headerlink" href="#The-committor" title="Permalink to this headline">¶</a></h2>
<p>One of the questions that can be answered with TPT is: If the man is at some state <span class="math">\((i,j)\)</span>, what is the probability that he reaches the bar before home? If he is already already at the bar, the probability is <span class="math">\(1\)</span>, i.e.,</p>
<div class="math">
\[\mathbb{P}((i,j)) = 0\;\forall (i,j)\in\mathrm{Home}

\]</div>
<p>and vice versa</p>
<div class="math">
\[\mathbb{P}((i,j)) = 1\;\forall (i,j)\in\mathrm{Bar}.

\]</div>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Law_of_total_probability">law of total probability</a> tells us that to know the probability of an event <span class="math">\(A\)</span> with a known and at most countably infinite set of mutually exclusive events <span class="math">\(\{C_n : n\in\mathbb{N}\}\)</span> so that <span class="math">\(\sum_i \mathbb{P}(C_i) = 1\)</span>, one can evaluate</p>
<div class="math">
\[\mathbb{P}(A) = \sum_n \mathbb{P}(A\mid C_n)\mathbb{P}(C_n).\]</div>
<p>In our example and ignoring borders and barriers, this means that for a current state <span class="math">\(s=(i,j)\)</span> and <span class="math">\(A=\text{&quot;Home from state }s\text{&quot;}\)</span> the sample space consists of direct neighbor states, i.e.,</p>
<div class="math">
\[C = \{ \text{move from }s\text{ to }s+(k,l) : (k,l)\in \{ -1, 0, 1 \}^2 \text{ and } (k,l)\neq (0, 0) \} \}.\]</div>
<p>Then,</p>
<div class="math">
\[\mathbb{P}(\text{Home from }s) = \sum_{C_{(k,l)}\in C} \mathbb{P}(\text{Home from }s+(k,l))\mathbb{P}(C_{(k,l)}).\]</div>
<p>But the <span class="math">\(\mathbb{P}(C_{(k,l)})\)</span> are exactly the transition probabilities to move from state <span class="math">\(s\)</span> to <span class="math">\(s+(k,l)\)</span>, giving rise to the <em>forward committor</em></p>
<div class="math">
\[q_s^{(+)} = q_{(i,j)}^{(+)} = \sum_{(k,l)\neq(0, 0)} q_{(i+k, j+l)}^{(+)}p_{(i,j),(i+k, j+l)},\]</div>
<p>where <span class="math">\(p_{(i,j),(i+k, j+l)}\)</span> is the probability to transition from state <span class="math">\(s=(i,j)\)</span> to one of its neighboring states.</p>
<p><strong>More formally</strong>, the forward committor probability is the probability to reach set of states <span class="math">\(A\)</span> before <span class="math">\(B\)</span>. Using the first hitting time of a set <span class="math">\(S\)</span> given by</p>
<div class="math">
\[T_{S}=\inf\{t \geq 0 : X_t \in S \},

\]</div>
<p>it can be defined as</p>
<div class="math">
\[q^{(+)}_i=\mathbb{P}_{i}(T_{A} < T_{B}).\]</div>
<p>It also satisfies the boundary value problem (BVP)</p>
<div class="math">
\[\begin{aligned}
q_i^{(+)} &= 0 &&\text{, for all }i\in A,\\
q_i^{(+)} &= 1 &&\text{, for all }i\in B,\\
\sum_j L_{ij} q^{(+)}_{j}&=0 &&\text{, for all }i\not\in A\cup B,\\
\end{aligned}\]</div>
<p>where <span class="math">\(L=P-\mathbb{I}\)</span> is the generator matrix and <span class="math">\(P\)</span> the transition matrix. The BVP-formulation is used to numerically find the forward committor.</p>
<p>There is also the notion of a <em>backward committor</em>, which is the probability that given state <span class="math">\(i\)</span>, the system has previously been in set <span class="math">\(A\)</span> rather than <span class="math">\(B\)</span>. With detailed balance, the backward committor is given by <span class="math">\(q_i^{(-)} = 1 - q_i^{(+)}\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">dividers</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">))]</span>
<span class="n">caxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span> <span class="k">for</span> <span class="n">divider</span> <span class="ow">in</span> <span class="n">dividers</span><span class="p">]</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Forward committor&quot;</span><span class="p">,</span> <span class="s2">&quot;Backward committor&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plot_2d_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">barrier_mode</span><span class="o">=</span><span class="s1">&#39;hollow&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">forward_committor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">backward_committor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">caxes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_14_0.png" src="../_images/notebooks_tpt_14_0.png" />
</div>
</div>
<p>As one can observe, the forward committor probabilities increase gradually when moving from home to bar, vice versa for the backward committor. This is expected as the Markov state model is reversible.</p>
</section>
<section id="Reactive-probability-flux">
<h2>Reactive probability flux<a class="headerlink" href="#Reactive-probability-flux" title="Permalink to this headline">¶</a></h2>
<p>If one is interested in the current of trajectories making their way from a set of states <span class="math">\(A\)</span> to a set of states <span class="math">\(B\)</span> (without trajectories that, e.g., leave <span class="math">\(A\)</span> just to go back to <span class="math">\(A\)</span> and only then enter <span class="math">\(B\)</span>), TPT offers the <em>reactive flux</em>. The relevant <em>gross flux</em> between two states <span class="math">\(i\)</span> and <span class="math">\(j\)</span> is then given by</p>
<div class="math">
\[f_{ij}^{AB} = \begin{cases}q_i^{(-)}\pi_i p_{ij}q_j^{(+)} &\text{, if }i\neq j,\\ 0 &\text{, otherwise.}\end{cases}\]</div>
<p>The flux is conserved between intermediate states</p>
<div class="math">
\[\sum_j f_{ij}^{AB} - f_{ji}^{AB} = 0\;\forall i\not\in A\cup B,\]</div>
<p>and also throughout the entire network</p>
<div class="math">
\[\sum_{i\in A,j\not in A}f_{ij}^{AB} = \sum_{i\not\in B, j\in B} f_{ij}^{AB}.\]</div>
<p>The considered <em>gross flux</em> can include detours of the form <span class="math">\(A\rightarrow\ldots\rightarrow i\rightarrow j\rightarrow i\rightarrow j\rightarrow\ldots\rightarrow B\)</span>, which can be (in the case of detailed balance) excluded by considering the <em>net flux</em></p>
<div class="math">
\[f_{ij}^{AB,+} = \max\{ 0, f_{ij}^{AB}-f_{ji}^{AB} \}.\]</div>
<p>In general and without detailed balance, the net flux might still contain such detours.</p>
<p>In deeptime, the gross and net flux are accessible from the <a class="reference internal" href="../api/generated/deeptime.markov.ReactiveFlux.html"><span class="doc">ReactiveFlux</span></a> object as <span class="math">\((n_\mathrm{states}\times n_\mathrm{states})\)</span> numpy arrays, where the first dimension corresponds to state <span class="math">\(i\)</span>, the second dimension corresponds to state <span class="math">\(j\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gross flux shape </span><span class="si">{</span><span class="n">flux</span><span class="o">.</span><span class="n">gross_flux</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, net flux shape </span><span class="si">{</span><span class="n">flux</span><span class="o">.</span><span class="n">net_flux</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Gross flux shape (100, 100), net flux shape (100, 100)
</pre></div></div>
</div>
<p>The example simulator offers plotting functionality so that the fluxes can be visualized:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">dividers</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">))]</span>
<span class="n">caxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span> <span class="k">for</span> <span class="n">divider</span> <span class="ow">in</span> <span class="n">dividers</span><span class="p">]</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Gross flux&quot;</span><span class="p">,</span> <span class="s2">&quot;Net flux&quot;</span><span class="p">]</span>
<span class="n">fluxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">flux</span><span class="o">.</span><span class="n">gross_flux</span><span class="p">,</span> <span class="n">flux</span><span class="o">.</span><span class="n">net_flux</span><span class="p">]</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">copper_r</span>
<span class="n">thresh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">fluxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">F</span><span class="p">)])</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

    <span class="n">sim</span><span class="o">.</span><span class="n">plot_2d_map</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">plot_network</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">connection_threshold</span><span class="o">=</span><span class="n">thresh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">),</span> <span class="n">cax</span><span class="o">=</span><span class="n">caxes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_20_0.png" src="../_images/notebooks_tpt_20_0.png" />
</div>
</div>
<p>From the gross flux one can derive the <em>total flux</em>, the total number of reactive <span class="math">\(A\rightarrow B\)</span> trajectories per time unit</p>
<div class="math">
\[f_{\mathrm{tot}}^{AB} = \sum_{i\in A, j\not\in A}f_{ij}^{AB},\]</div>
<p>which can be accessed by:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total flux = </span><span class="si">{</span><span class="n">flux</span><span class="o">.</span><span class="n">total_flux</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">/step&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total flux = 6.165e-05/step
</pre></div></div>
</div>
<p>This quantity gives rise to the <em>total transition rate</em>, which is the number of events given we start in <span class="math">\(A\)</span></p>
<div class="math">
\[k_{AB} = \frac{f_\mathrm{tot}^{AB}}{\sum_i\pi_iq_i^{(-)}}\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rate = </span><span class="si">{</span><span class="n">flux</span><span class="o">.</span><span class="n">rate</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">/step&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Rate = 1.264e-04/step
</pre></div></div>
</div>
<p>which is also the inverse <span class="math">\(A\to B\)</span> mean first passage time <span class="math">\(\mathrm{mfpt} = 1/k_{AB}\)</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MFPT = </span><span class="si">{</span><span class="n">flux</span><span class="o">.</span><span class="n">mfpt</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> steps&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MFPT = 7911.887 steps
</pre></div></div>
</div>
</section>
<section id="Coarse-graining-of-fluxes">
<h2>Coarse-graining of fluxes<a class="headerlink" href="#Coarse-graining-of-fluxes" title="Permalink to this headline">¶</a></h2>
<p>For better interpretability, one can cluster microstates defined in a Markov state model into metastable sets using, e.g., <a class="reference internal" href="pcca.html"><span class="doc">PCCA+</span></a>.</p>
<p>In our example, we might select six clusters:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pcca</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">msm</span><span class="o">.</span><span class="n">pcca</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>and depict the membership probabilities for each state</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memberships for metastable set </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plot_2d_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">barrier_mode</span><span class="o">=</span><span class="s1">&#39;hollow&#39;</span><span class="p">)</span>

    <span class="n">Q</span> <span class="o">=</span> <span class="n">pcca</span><span class="o">.</span><span class="n">memberships</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">);</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">.8</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_30_0.png" src="../_images/notebooks_tpt_30_0.png" />
</div>
</div>
<p>Also reactive fluxes can be coarse-grained by lumping together states - without systematic error as in the PCCA case. For simplicity, we coarse grain onto <span class="math">\(A\)</span>, <span class="math">\(B\)</span>, and the remainder subdivided into the upper half (<span class="math">\(j\geq 5\)</span>) and the lower half.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">remainder_upper</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">remainder_lower</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">coordinate_to_state</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sim</span><span class="o">.</span><span class="n">home_state</span> <span class="o">+</span> <span class="n">sim</span><span class="o">.</span><span class="n">bar_state</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">remainder_upper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">remainder_lower</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sets</span><span class="p">,</span> <span class="n">tpt</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">coarse_grain</span><span class="p">([</span><span class="n">sim</span><span class="o">.</span><span class="n">home_state</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">bar_state</span><span class="p">,</span> <span class="n">remainder_upper</span><span class="p">,</span> <span class="n">remainder_lower</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>As expected we obtain four sets which are exactly the home states, the bar states, and the subdivided remainder.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># enumerating assignments</span>
<span class="n">assignments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">n_states</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flux_set</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">):</span>
    <span class="n">assignments</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flux_set</span><span class="p">))]</span> <span class="o">=</span> <span class="n">i</span>
<span class="n">assignments</span> <span class="o">=</span> <span class="n">assignments</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>

<span class="c1"># plot assignments</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assignments</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">.5</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">3.5</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;Set 0&#39;</span><span class="p">,</span> <span class="s1">&#39;Set 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Set 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Set 3&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_35_0.png" src="../_images/notebooks_tpt_35_0.png" />
</div>
</div>
<p>The return value also contains the fluxes plus derived quantities: The gross flux has a forward-backward cycle between upper and lower set, while the net flux lacks this cycle.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">graphs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">))]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Gross flux&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Net flux&quot;</span><span class="p">)</span>

    <span class="n">F</span> <span class="o">=</span> <span class="n">tpt</span><span class="o">.</span><span class="n">gross_flux</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">tpt</span><span class="o">.</span><span class="n">net_flux</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">graphs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)):</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Set </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">edge_labels</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_edge_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1100</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">));</span>
    <span class="n">fragments</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edge_labels</span><span class="o">=</span><span class="n">edge_labels</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-|&gt;&#39;</span><span class="p">,</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                           <span class="n">connectionstyle</span><span class="o">=</span><span class="s1">&#39;arc3, rad=0.3&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_37_0.png" src="../_images/notebooks_tpt_37_0.png" />
</div>
</div>
</section>
<section id="Pathway-decomposition">
<h2>Pathway decomposition<a class="headerlink" href="#Pathway-decomposition" title="Permalink to this headline">¶</a></h2>
<p>A pathway is a sequence of states <span class="math">\(P=(s_1,s_2,\ldots,s_k)\)</span> so that <span class="math">\(s_1\in A\)</span> and <span class="math">\(s_k\in B\)</span>. One can associate a capacity (the minimal current) to a pathway via</p>
<div class="math">
\[f(P) = \min\{ f_{s_i s_{i+1}}^{AB} : i=1,\ldots, k-1\}.\]</div>
<p>A pathway decomposition is then the repeated choosing of a path and subsequent removal of its capacity along its edges until no flux remains.</p>
<p>The decomposition is not unique and depends on the order in which the paths are choosen. In deeptime, a pathway decomposition is implemented by iteratively removing the currently strongest pathway (i.e., with largest capacity).</p>
<p>A call to <a class="reference internal" href="../api/generated/deeptime.markov.ReactiveFlux.html#deeptime.markov.ReactiveFlux.pathways"><span class="std std-ref">pathways()</span></a> performs said operation. One can optionally give a fraction (default 1.0) which stops the decomposition when the given fraction of the total flux is reached with the decomposition. The default tries to the flux into all dominant pathways which can be computationally intensive for large networks. Furthermore one can set a hard limit on the number of computed pathways via the
<code class="docutils literal notranslate"><span class="pre">maxiter</span></code> argument.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">paths</span><span class="p">,</span> <span class="n">capacities</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">pathways</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
4
</pre></div></div>
</div>
<p>In this example, we can represent <span class="math">\(30\%\)</span> of the total flux with four pathways.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">capacities</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">paths</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sim</span><span class="o">.</span><span class="n">state_to_coordinate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">plot_path</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">capacity</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">intermediates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">color_lerp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Capacity </span><span class="si">{</span><span class="n">capacity</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plot_2d_map</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_42_0.png" src="../_images/notebooks_tpt_42_0.png" />
</div>
</div>
</section>
<section id="Example-from-trajectories">
<h2>Example from trajectories<a class="headerlink" href="#Example-from-trajectories" title="Permalink to this headline">¶</a></h2>
<p>Using the same example we can generate timeseries which can be used to re-estimate a Markov state model and perform a TPT analysis. To this end, we simulate 1000 trajectories all starting from the same point and return the micro states directly rather than <span class="math">\((i, j)\)</span> coordinates.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">trajs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">trajs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">return_states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>From these trajectories we can count state transitions based on the prior knowledge that there are actually <span class="math">\(100\)</span> states and select the largest connected submodel - which due to the barriers does not contain all the states.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">deeptime.markov</span> <span class="kn">import</span> <span class="n">TransitionCountEstimator</span>

<span class="n">count_model</span> <span class="o">=</span> <span class="n">TransitionCountEstimator</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sliding&#39;</span><span class="p">,</span> <span class="n">n_states</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">n_states</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trajs</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_model</span><span class="p">()</span>
<span class="n">count_model</span> <span class="o">=</span> <span class="n">count_model</span><span class="o">.</span><span class="n">submodel_largest</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;States not included in the count model: &quot;</span>
      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">count_model</span><span class="o">.</span><span class="n">n_states_full</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">count_model</span><span class="o">.</span><span class="n">state_symbols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
States not included in the count model: {15, 25, 28, 29, 35, 38, 45, 47, 48, 55, 57, 62, 63, 64, 65, 67, 83, 84, 85, 90, 91, 92, 93}
</pre></div></div>
</div>
<p>Based on this we can estimate a Markov state model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">deeptime.markov.msm</span> <span class="kn">import</span> <span class="n">MaximumLikelihoodMSM</span>

<span class="n">mlmsm</span> <span class="o">=</span> <span class="n">MaximumLikelihoodMSM</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">count_model</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>While we represent all counts in the markov state model, only a fraction of the states is represented - as expected:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Count fraction:&quot;</span><span class="p">,</span> <span class="n">mlmsm</span><span class="o">.</span><span class="n">count_fraction</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;State fraction:&quot;</span><span class="p">,</span> <span class="n">mlmsm</span><span class="o">.</span><span class="n">state_fraction</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Count fraction: 1.0
State fraction: 0.77
</pre></div></div>
</div>
<p>On this we can compute the reactive flux:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">flux</span> <span class="o">=</span> <span class="n">mlmsm</span><span class="o">.</span><span class="n">reactive_flux</span><span class="p">(</span>
     <span class="n">mlmsm</span><span class="o">.</span><span class="n">count_model</span><span class="o">.</span><span class="n">symbols_to_states</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">home_state</span><span class="p">),</span>
     <span class="n">mlmsm</span><span class="o">.</span><span class="n">count_model</span><span class="o">.</span><span class="n">symbols_to_states</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">bar_state</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>And perform the above described analyses, for example a pathway decomposition and the forward committor:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">paths</span><span class="p">,</span> <span class="n">capacities</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">pathways</span><span class="p">(</span><span class="mf">.3</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Forward committor and pathway decomposition.&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">capacities</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">paths</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">mlmsm</span><span class="o">.</span><span class="n">count_model</span><span class="o">.</span><span class="n">states_to_symbols</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sim</span><span class="o">.</span><span class="n">state_to_coordinate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">path</span><span class="p">])</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">plot_path</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">capacity</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Capacity </span><span class="si">{</span><span class="n">capacity</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                  <span class="n">intermediates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color_lerp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plot_2d_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">barriers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">sim</span><span class="o">.</span><span class="n">n_states</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">Q</span><span class="p">[</span><span class="n">mlmsm</span><span class="o">.</span><span class="n">state_symbols</span><span class="p">()]</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">forward_committor</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>

<span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_tpt_55_0.png" src="../_images/notebooks_tpt_55_0.png" />
</div>
</div>
<p>Comparing this plot with the ones above one can notice that the hard barriers are ‘missing’, meaning that they were not sampled in the trajectories and now show up as white cubes due to the image being initialized as <span class="math">\(10\times 10\)</span> array filled with <code class="docutils literal notranslate"><span class="pre">np.nan</span></code>.</p>
<p class="rubric">References</p>
<p id="id8"><dl class="footnote brackets">
<dt class="label" id="footcite-weinan2006towards"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Weinan E and Eric Vanden-Eijnden. Towards a theory of transition paths. <em>Journal of statistical physics</em>, 123(3):503, 2006.</p>
</dd>
<dt class="label" id="footcite-metzner2009transition"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Philipp Metzner, Christof Schütte, and Eric Vanden-Eijnden. Transition path theory for markov jump processes. <em>Multiscale Modeling &amp; Simulation</em>, 7(3):1192–1219, 2009.</p>
</dd>
<dt class="label" id="footcite-noe2009constructing"><span class="brackets">3</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id4">2</a>)</span></dt>
<dd><p>Frank Noé, Christof Schütte, Eric Vanden-Eijnden, Lothar Reich, and Thomas R Weikl. Constructing the equilibrium ensemble of folding pathways from short off-equilibrium simulations. <em>Proceedings of the National Academy of Sciences</em>, 106(45):19011–19016, 2009.</p>
</dd>
<dt class="label" id="footcite-berezhkovskii2009reactive"><span class="brackets"><a class="fn-backref" href="#id5">4</a></span></dt>
<dd><p>Alexander Berezhkovskii, Gerhard Hummer, and Attila Szabo. Reactive flux and folding pathways in network models of coarse-grained protein dynamics. <em>The Journal of chemical physics</em>, 130(20):05B614, 2009.</p>
</dd>
<dt class="label" id="footcite-doyle1984random"><span class="brackets"><a class="fn-backref" href="#id6">5</a></span></dt>
<dd><p>Peter G Doyle and J Laurie Snell. <em>Random walks and electric networks</em>. Volume 22. American Mathematical Soc., 1984.</p>
</dd>
<dt class="label" id="footcite-valleriani2015circular"><span class="brackets"><a class="fn-backref" href="#id7">6</a></span></dt>
<dd><p>Angelo Valleriani. Circular analysis in complex stochastic systems. <em>Scientific reports</em>, 5(1):1–6, 2015.</p>
</dd>
</dl>
</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
<script src="../_static/scrollbar.js"></script>

  </body>
</html>